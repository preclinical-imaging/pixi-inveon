# pixi-inveon
Python module for manipulating Siemens Inveon files

# Overview
The Siemens Inveon scanner for small animal imaging produces native output data in two related files with .img and .hdr extensions.
These files are written from the console software.
Siemens provides a workstation with software that will convert to DICOM, but the conversion process requires too many manual steps.

The primary purpose of this software is to convert the Inveon proprietary data to DICOM images.

We have notes on the conversion process in [Specifications for Inveon to DICOM Conversion
](conversion_specifications.md)

## Conversion Considerations

The Inveon scanner produces 3D CT volumes and 4D PET data. This software is written with options to allow the user to create output files using these DICOM SOP Classes:

| SOP Class Name                              | SOP Class UID                 |
|---------------------------------------------|-------------------------------|
| CT Image Storage                            | 1.2.840.10008.5.1.4.1.1.2     |
| Enhanced CT Image Storage                   | 1.2.840.10008.5.1.4.1.1.2.1   |
| Legacy Converted Enhanced CT Image Storage  | 1.2.840.10008.5.1.4.1.1.2.2   |
| Positron Emission Tomography Image Storage  | 1.2.840.10008.5.1.4.1.1.128   |
| Enhanced PET Image Storage                  | 1.2.840.10008.5.1.4.1.1.130   |
| Legacy Converted Enhanced PET Image Storage | 1.2.840.10008.5.1.4.1.1.128.1 |



# Installation
1. pixi-inveon is a Python package that relies on python 3.10 or greater and pydicom 2.4.0 or greater
2. While in the early stages of development, the package is installed at test.pypi.org.

```
pip3 install -v pydicom
pip3 install -v numpy
pip3 install -v python-dateutil
pip3 install -v -i https://test.pypi.org/simple/ inveonimaging
```

# Usage
## Convert a Folder of Inveon files
* Convert a folder of Inveon files into one DICOM Study with a single DICOM Study Instance UID
* Each Inveon .img/.hdr pair is converted to one DICOM Series
* The default action is to produce CT Image and PET Image DICOM Part 10 files with each series stored in a separate folder.
* Files are named using the Instance Numbers generated by the software.
  * The user can add separate prefixes for CT and PET data
* Program does not tolerate files with other extensions in the input folder. It will raise an exception.
* Program does not tolerate mismatched .img and .hdr files.
* In the pre-beta period, do not use the -l and/or -m options.


```
python3 -m inveonimaging.inveonFolder2DICOM --help
usage: inveonFolder2DICOM.py [-h] [-C CODE_TABLE] 
        [-c CT_PREFIX] [-p PET_PREFIX] [-f FILE] [-l] [-m] [-s STUDY_DESCRIPTION]
        [--patientname PATIENT_NAME] [--patientid PATIENT_ID]
        [--patientdob PATIENT_BIRTHDATE] [--patientsex PATIENT_SEX]
        [--ignoreAllExtraFiles] [--ignoreFileWithExt IGNORE_SPECIFIC_EXTRA_FILES]
        InveonFolder OutputFolder

Inveon native .img/.hdr file to DICOM original

positional arguments:
  InveonFolder          Path to Inveon .hdr/.img file(s)
  OutputFolder          Path to output folder for DICOM files

options:
  -h, --help            show this help message and exit
  -C CODE_TABLE, --codetable CODE_TABLE
                        JSON file with code table
  -c CT_PREFIX, --ct CT_PREFIX
                        Prefix for a CT file
  -p PET_PREFIX, --pet PET_PREFIX
                        Prefix for a PET file
  -f FILE, --file FILE  Name of output file for multiframe output
  -l, --legacyconverted
  -m, --multiframe
  -s STUDY_DESCRIPTION, --studydescription STUDY_DESCRIPTION
                        Set DICOM StudyDescription
  --patientname PATIENT_NAME
                        Set DICOM PatientName
  --patientid PATIENT_ID
                        Set DICOM PatientID
  --patientdob PATIENT_BIRTHDATE
                        Set DICOM PatientBirthDate
  --patientsex PATIENT_SEX
                        Set DICOM PatientSex
  --ignoreAllExtraFiles
                        Ignore presence of all files with extension other than .img and .hdr
  --ignoreFileWithExt IGNORE_SPECIFIC_EXTRA_FILES
                        Ignore presence of files with specific extension other than .img and .hdr


```
** Code Table **
The program uses a JSON file to translate from data entered at the console to the coded value in the DICOM file in (0054,0013) EnergyWindowRangeSequence / >(0054,0300) RadionuclideCodeSequence.
The value entered at the console is likely from local practice. This table maps to standard values.

This is an example of such a mapping file. The value for "key" is what is entered at the console. The fields code, meaning, system map to DICOM elements in the (0054,0300) RadionuclideCodeSequence.
```
[
  {"key": "Cu-64", "code": "C-127A2", "meaning": "^64^Copper",   "system": "SNM3"},
  {"key": "F-18",  "code": "C-111A1", "meaning": "^18^Fluorine", "system": "SNM3"},
  {"key": "Ga-68", "code": "C-131A3", "meaning": "^68^Gallium",  "system": "SNM3"},
  {"key": "O-15",  "code": "C-B1038", "meaning": "^15^Oxygen",   "system": "SNM3"}
]
```
If the value "O-15" is entered at the console, the coded values in the DICOM header will be:
```
(0054,0016) SQ RadiopharmaceuticalInformationSequence
>  (0054,0300) SQ RadionuclideCodeSequence
>>   (0008,0100) SH #8 [C-B1038] CodeValue
>>   (0008,0102) SH #4 [SNM3] CodingSchemeDesignator
>>   (0008,0104) LO #10 [^15^Oxygen] CodeMeaning
```

**Example With CT and PET Scans**
The folder */opt/datasets/SAI_WUSTL/Sample_Inveon_DICOM/test_1* contains these four files:
* mpet4800a_ct1_v1.ct.img
* mpet4800a_ct1_v1.ct.img.hdr
* mpet4800a_em111_v1.pet.img
* mpet4800a_em111_v1.pet.img.hdr

```
python3 -m inveonimaging.inveonFolder2DICOM -c CT- -p PET- /opt/datasets/SAI_WUSTL/Sample_Inveon_DICOM/test_1 /tmp/test_1/single_frame
```
This produces (where xxxxxx is the generated DICOM Intance Number)
* /tmp/test_1/single_frame/1/CT-xxxxxx.dcm
* /tmp/test_1/single_frame/2/PET-xxxxxx.dcm



# Notes
* There are known issues listed in [Specifications for Inveon to DICOM Conversion
](conversion_specifications.md)

